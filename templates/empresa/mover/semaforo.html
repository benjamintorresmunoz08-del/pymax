<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pymax | Financial Health Monitor</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/static/js/pymax-real-auth.js"></script>

    <style>
        :root {
            --bg-void: #020617;
            --bg-card: rgba(15, 23, 42, 0.6);
            --border-glass: rgba(255, 255, 255, 0.08);
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg-void);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        h1, h2, h3, h4 {
            font-family: 'Outfit', sans-serif;
            letter-spacing: -0.02em;
        }

        .nebula-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            background: radial-gradient(circle at 20% 50%, rgba(239, 68, 68, 0.03) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(34, 197, 94, 0.03) 0%, transparent 50%);
            pointer-events: none;
        }

        .glass-card {
            background: var(--bg-card);
            border: 1px solid var(--border-glass);
            border-radius: 24px;
            backdrop-filter: blur(24px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* Traffic Light */
        .traffic-light {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
        }

        .light-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            transition: all 0.5s ease;
        }

        .light-circle.red {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.4) 0%, rgba(239, 68, 68, 0.1) 100%);
            border: 4px solid #ef4444;
            box-shadow: 0 0 60px rgba(239, 68, 68, 0.6), inset 0 0 40px rgba(239, 68, 68, 0.3);
        }

        .light-circle.yellow {
            background: radial-gradient(circle, rgba(251, 191, 36, 0.4) 0%, rgba(251, 191, 36, 0.1) 100%);
            border: 4px solid #fbbf24;
            box-shadow: 0 0 60px rgba(251, 191, 36, 0.6), inset 0 0 40px rgba(251, 191, 36, 0.3);
        }

        .light-circle.green {
            background: radial-gradient(circle, rgba(34, 197, 94, 0.4) 0%, rgba(34, 197, 94, 0.1) 100%);
            border: 4px solid #22c55e;
            box-shadow: 0 0 60px rgba(34, 197, 94, 0.6), inset 0 0 40px rgba(34, 197, 94, 0.3);
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 40px var(--glow-color), inset 0 0 20px var(--glow-color); }
            50% { box-shadow: 0 0 80px var(--glow-color), inset 0 0 40px var(--glow-color); }
        }

        .light-circle.pulse {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* Score Display */
        .score-display {
            font-size: 4rem;
            font-weight: 800;
            background: linear-gradient(135deg, #34d399, #22d3ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Factor Card */
        .factor-card {
            padding: 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            border-left: 3px solid;
            transition: all 0.2s ease;
        }

        .factor-card.positive { border-left-color: #22c55e; }
        .factor-card.neutral { border-left-color: #fbbf24; }
        .factor-card.negative { border-left-color: #ef4444; }

        .factor-card:hover {
            transform: translateX(4px);
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Modern Button */
        .modern-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #34d399, #10b981);
            color: white;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(52, 211, 153, 0.3); border-radius: 10px; }
    </style>
</head>

<body>
    <div class="nebula-bg"></div>

    <!-- Navigation -->
    <nav class="fixed top-0 left-0 w-full z-50 bg-[#020617]/90 backdrop-blur-md border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 md:px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="/empresa/mover" class="flex items-center gap-2 text-slate-400 hover:text-white transition group">
                    <div class="w-8 h-8 rounded-lg bg-white/5 flex items-center justify-center border border-white/10 group-hover:border-white/30 transition">
                        <i class="ph-bold ph-arrow-left"></i>
                    </div>
                    <span class="hidden md:inline text-xs font-bold uppercase tracking-widest">Back</span>
                </a>
                <div class="h-6 w-px bg-white/10"></div>
                <h1 class="text-xl font-bold text-white font-display tracking-tight">
                    PYMAX <span class="text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400">HEALTH MONITOR</span>
                </h1>
            </div>

            <div class="flex items-center gap-3">
                <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
                    <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                    <span class="text-xs font-semibold text-emerald-400">System Active</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 md:px-6 pt-24 pb-12 relative z-10">

        <div class="grid lg:grid-cols-12 gap-8">

            <!-- Left Column: Traffic Light & Score -->
            <div class="lg:col-span-5 space-y-6">

                <!-- Main Traffic Light -->
                <div class="glass-card p-8 text-center fade-in">
                    <h2 class="text-sm font-bold uppercase tracking-widest text-slate-500 mb-6">Financial Health Status</h2>
                    
                    <div class="traffic-light mb-6">
                        <div class="light-circle green pulse" id="trafficLight" style="--glow-color: rgba(34, 197, 94, 0.6);">
                            <i class="ph-fill ph-check-circle" style="color: #22c55e;"></i>
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="score-display" id="healthScore">85</div>
                        <p class="text-xs uppercase tracking-wide text-slate-400 font-bold">Health Score</p>
                    </div>

                    <div class="p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/30">
                        <p class="text-sm font-bold text-emerald-400 mb-1" id="statusTitle">Excellent Health</p>
                        <p class="text-xs text-slate-300" id="statusDescription">Your financial metrics are strong. Continue monitoring to maintain this status.</p>
                    </div>
                </div>

                <!-- Score History Chart -->
                <div class="glass-card p-6 fade-in">
                    <h3 class="text-lg font-bold text-white font-display mb-4">Health Trend</h3>
                    <div style="height: 220px;">
                        <canvas id="scoreChart"></canvas>
                    </div>
                </div>

            </div>

            <!-- Right Column: Factors & Recommendations -->
            <div class="lg:col-span-7 space-y-6">

                <!-- Key Factors -->
                <div class="glass-card p-6 fade-in">
                    <h3 class="text-lg font-bold text-white font-display mb-4 flex items-center gap-2">
                        <i class="ph-duotone ph-gauge text-cyan-400"></i>
                        Key Health Factors
                    </h3>

                    <div class="space-y-3">
                        <div class="factor-card positive">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="ph-fill ph-arrow-up text-emerald-400 text-lg"></i>
                                    <p class="font-bold text-white text-sm">Cash Flow</p>
                                </div>
                                <span class="text-sm font-bold text-emerald-400">+18%</span>
                            </div>
                            <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-emerald-500 to-emerald-400" style="width: 85%"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-2">Positive trend. Strong liquidity position.</p>
                        </div>

                        <div class="factor-card positive">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="ph-fill ph-chart-line text-cyan-400 text-lg"></i>
                                    <p class="font-bold text-white text-sm">Revenue Growth</p>
                                </div>
                                <span class="text-sm font-bold text-cyan-400">+22%</span>
                            </div>
                            <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-400" style="width: 92%"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-2">Excellent growth. Exceeding projections.</p>
                        </div>

                        <div class="factor-card neutral">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="ph-fill ph-minus text-amber-400 text-lg"></i>
                                    <p class="font-bold text-white text-sm">Expense Control</p>
                                </div>
                                <span class="text-sm font-bold text-amber-400">+5%</span>
                            </div>
                            <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-amber-500 to-orange-400" style="width: 68%"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-2">Expenses increased slightly. Monitor closely.</p>
                        </div>

                        <div class="factor-card positive">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="ph-fill ph-shield-check text-emerald-400 text-lg"></i>
                                    <p class="font-bold text-white text-sm">Debt Management</p>
                                </div>
                                <span class="text-sm font-bold text-emerald-400">-12%</span>
                            </div>
                            <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-emerald-500 to-teal-400" style="width: 88%"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-2">Debt reduction on track. Great progress.</p>
                        </div>

                        <div class="factor-card positive">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="ph-fill ph-piggy-bank text-cyan-400 text-lg"></i>
                                    <p class="font-bold text-white text-sm">Savings Rate</p>
                                </div>
                                <span class="text-sm font-bold text-cyan-400">27%</span>
                            </div>
                            <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-400" style="width: 75%"></div>
                            </div>
                            <p class="text-xs text-slate-400 mt-2">Above average. Excellent financial discipline.</p>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="glass-card p-6 fade-in">
                    <h3 class="text-lg font-bold text-white font-display mb-4 flex items-center gap-2">
                        <i class="ph-duotone ph-lightbulb text-amber-400"></i>
                        AI Recommendations
                    </h3>

                    <div class="space-y-3 text-sm">
                        <div class="p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/20">
                            <div class="flex items-start gap-3">
                                <i class="ph-fill ph-check-circle text-emerald-400 text-xl"></i>
                                <div>
                                    <p class="font-bold text-emerald-300 mb-1 text-xs uppercase tracking-wide">Strength</p>
                                    <p class="text-slate-300 text-xs">Your cash reserves can cover 4.2 months of expenses. This provides excellent security.</p>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-amber-500/10 rounded-xl border border-amber-500/20">
                            <div class="flex items-start gap-3">
                                <i class="ph-fill ph-warning text-amber-400 text-xl"></i>
                                <div>
                                    <p class="font-bold text-amber-300 mb-1 text-xs uppercase tracking-wide">Watch</p>
                                    <p class="text-slate-300 text-xs">Marketing expenses increased 8% this month. Review ROI on recent campaigns.</p>
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-cyan-500/10 rounded-xl border border-cyan-500/20">
                            <div class="flex items-start gap-3">
                                <i class="ph-fill ph-lightbulb text-cyan-400 text-xl"></i>
                                <div>
                                    <p class="font-bold text-cyan-300 mb-1 text-xs uppercase tracking-wide">Opportunity</p>
                                    <p class="text-slate-300 text-xs">Consider allocating $1,500/month to investment portfolio based on current surplus.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status History -->
                <div class="glass-card p-6 fade-in">
                    <h3 class="text-lg font-bold text-white font-display mb-4">Status History</h3>
                    
                    <div class="space-y-3 text-xs">
                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg">
                            <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center">
                                <i class="ph-fill ph-check text-emerald-400"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-white">Green Status</p>
                                <p class="text-slate-400">Since Jan 15, 2026</p>
                            </div>
                            <span class="text-slate-500">28 days</span>
                        </div>

                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg opacity-60">
                            <div class="w-8 h-8 rounded-full bg-amber-500/20 flex items-center justify-center">
                                <i class="ph-fill ph-warning text-amber-400"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-white">Yellow Status</p>
                                <p class="text-slate-400">Dec 20 - Jan 14, 2026</p>
                            </div>
                            <span class="text-slate-500">25 days</span>
                        </div>

                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg opacity-40">
                            <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center">
                                <i class="ph-fill ph-check text-emerald-400"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-white">Green Status</p>
                                <p class="text-slate-400">Nov 5 - Dec 19, 2025</p>
                            </div>
                            <span class="text-slate-500">44 days</span>
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </main>

    <!-- JavaScript -->
    <script>
        const SU_URL = 'https://haqjuyagyvxynmulanhe.supabase.co';
        const SU_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhhcWp1eWFneXZ4eW5tdWxhbmhlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MjU0MjQsImV4cCI6MjA4MTQwMTQyNH0.3aSIfr3s5spESzEv_UAaqYkJzVyhbkK8ZpSlExY0A3g';
        const client = supabase.createClient(SU_URL, SU_KEY);

        let scoreChart = null;

        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            background: '#0b0b14',
            color: '#fff'
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const user = await checkRealAuth(client);
            if (!user) return;
            await calculateHealth();
            initializeChart();
        });

        async function calculateHealth() {
            try {
                const { data: { user } } = await client.auth.getUser();
                if (!user) {
                    console.warn('No user found, using demo mode');
                    setDemoHealth();
                    return;
                }

                // Load operations and calculate real health
                const { data: operations } = await client
                    .from('user_operations')
                    .select('*')
                    .eq('user_id', user.id);

                if (operations && operations.length > 0) {
                    const income = operations.filter(o => o.type === 'ingreso').reduce((sum, o) => sum + parseFloat(o.amount || 0), 0);
                    const expense = operations.filter(o => o.type === 'gasto').reduce((sum, o) => sum + parseFloat(o.amount || 0), 0);
                    const balance = income - expense;
                    
                    // Calculate score
                    let score = 50;
                    if (balance > 0) score += 20;
                    if (income > expense * 1.5) score += 15;
                    if (operations.length >= 10) score += 10;
                    score = Math.min(100, score);

                    updateHealthStatus(score);
                } else {
                    setDemoHealth();
                }

            } catch (error) {
                console.error('Error:', error);
                setDemoHealth();
            }
        }

        function setDemoHealth() {
            updateHealthStatus(85);
        }

        function updateHealthStatus(score) {
            document.getElementById('healthScore').textContent = score;

            const light = document.getElementById('trafficLight');
            const title = document.getElementById('statusTitle');
            const description = document.getElementById('statusDescription');

            if (score >= 80) {
                light.className = 'light-circle green pulse';
                light.style.setProperty('--glow-color', 'rgba(34, 197, 94, 0.6)');
                light.innerHTML = '<i class="ph-fill ph-check-circle" style="color: #22c55e;"></i>';
                title.textContent = 'Excellent Health';
                title.className = 'text-sm font-bold text-emerald-400 mb-1';
                description.textContent = 'Your financial metrics are strong. Continue monitoring to maintain this status.';
                description.parentElement.className = 'p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/30';
            } else if (score >= 60) {
                light.className = 'light-circle yellow pulse';
                light.style.setProperty('--glow-color', 'rgba(251, 191, 36, 0.6)');
                light.innerHTML = '<i class="ph-fill ph-warning" style="color: #fbbf24;"></i>';
                title.textContent = 'Moderate Health';
                title.className = 'text-sm font-bold text-amber-400 mb-1';
                description.textContent = 'Some areas need attention. Review expenses and cash flow carefully.';
                description.parentElement.className = 'p-4 bg-amber-500/10 rounded-xl border border-amber-500/30';
            } else {
                light.className = 'light-circle red pulse';
                light.style.setProperty('--glow-color', 'rgba(239, 68, 68, 0.6)');
                light.innerHTML = '<i class="ph-fill ph-x-circle" style="color: #ef4444;"></i>';
                title.textContent = 'Attention Required';
                title.className = 'text-sm font-bold text-rose-400 mb-1';
                description.textContent = 'Critical issues detected. Take immediate action to improve financial position.';
                description.parentElement.className = 'p-4 bg-rose-500/10 rounded-xl border border-rose-500/30';
            }
        }

        function initializeChart() {
            const ctx = document.getElementById('scoreChart');
            
            scoreChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [{
                        label: 'Health Score',
                        data: [72, 78, 82, 85],
                        borderColor: '#34d399',
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        tension: 0.4,
                        borderWidth: 3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#64748b', font: { size: 10 } }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { 
                                color: '#64748b',
                                callback: value => value + '%'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
