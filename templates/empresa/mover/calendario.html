<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Pymax · Agenda y Calendario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script src="../pymax-core.js"></script>

  <style>
    body {
      background:
        radial-gradient(900px 400px at 10% -10%, rgba(79,70,229,.25), transparent 40%),
        radial-gradient(800px 500px at 90% 10%, rgba(99,102,241,.18), transparent 45%),
        radial-gradient(700px 400px at 50% 120%, rgba(56,189,248,.12), transparent 40%),
        #020617;
    }

    .glass {
      background: rgba(15,23,42,0.65);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(148,163,184,0.15);
    }

    .hover-card {
      transition: transform .3s ease, box-shadow .3s ease;
    }

    .hover-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,.45);
    }

    .day {
      transition: all .25s ease;
      min-height: 100px; /* Altura suficiente para ver eventos */
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
    }

    .day:hover {
      background: rgba(99,102,241,.15);
      transform: scale(1.02);
      border-color: rgba(99,102,241,0.5);
    }

    /* Scrollbar fina para días con muchos eventos */
    .day::-webkit-scrollbar { width: 4px; }
    .day::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 2px; }
  </style>
</head>

<body class="text-slate-100 min-h-screen font-sans">

<div id="pymax-toast-container" class="fixed top-6 right-6 z-50 space-y-3"></div>

<header class="glass px-8 py-5 flex justify-between items-center border-b border-slate-800 sticky top-0 z-40">
  <h1 class="text-xl font-semibold text-indigo-400">
    Pymax · Agenda y Calendario
  </h1>
  <a href="panel-mover.html" class="text-sm text-slate-300 hover:text-white transition border border-slate-600 px-3 py-1 rounded hover:bg-slate-800">
    Volver al panel
  </a>
</header>

<main class="max-w-7xl mx-auto px-6 py-10 space-y-12">

  <section class="max-w-4xl">
    <h2 class="text-3xl font-semibold mb-3">
      Tu agenda inteligente (<span id="mes-actual-titulo" class="text-indigo-400">...</span>)
    </h2>
    <p class="text-slate-300 leading-relaxed">
      Agenda reuniones, pagos y eventos importantes.
      <span class="text-green-400 font-semibold">Nuevo:</span> El sistema enviará un recordatorio por correo <b>1 día antes</b> de cada actividad.
    </p>
  </section>

  <section class="grid grid-cols-1 md:grid-cols-3 gap-6">

    <div class="glass rounded-xl p-6 hover-card border-t-4 border-indigo-500">
      <p class="text-sm text-slate-400">Actividades este mes</p>
      <p id="val-total-mes" class="text-3xl font-bold text-indigo-400 mt-2">0</p>
      <p class="text-xs text-slate-400 mt-2">
        Reuniones, pagos y eventos agendados.
      </p>
    </div>

    <div class="glass rounded-xl p-6 hover-card border-t-4 border-yellow-500">
      <p class="text-sm text-slate-400">Próxima actividad</p>
      <p id="val-proximo" class="text-2xl font-bold text-yellow-400 mt-2 text-sm leading-tight pt-1">—</p>
      <p class="text-xs text-slate-400 mt-2">
        Lo más cercano en tu calendario.
      </p>
    </div>

    <div class="glass rounded-xl p-6 hover-card border-t-4 border-red-500">
      <p class="text-sm text-slate-400">Pendientes vencidos</p>
      <p id="val-vencidos" class="text-3xl font-bold text-red-400 mt-2">0</p>
      <p class="text-xs text-slate-400 mt-2">
        Actividades pasadas sin completar.
      </p>
    </div>

  </section>

  <section class="glass rounded-xl p-8 max-w-5xl">
    <h3 class="text-xl font-semibold mb-6 flex items-center gap-2 text-indigo-300">
      Agendar nueva actividad
    </h3>

    <form id="formCalendario" class="grid grid-cols-1 md:grid-cols-4 gap-4">

      <div class="md:col-span-3">
          <input id="inpDesc" type="text" placeholder="Título (Ej: Reunión Cliente, Pagar Luz...)" required
            class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-3 text-white focus:outline-none focus:border-indigo-500" />
      </div>

      <div class="md:col-span-1">
          <input id="inpFecha" type="date" required
            class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-3 text-white focus:outline-none focus:border-indigo-500" />
      </div>

      <div class="md:col-span-1">
          <select id="inpTipoSelect" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-3 text-white focus:outline-none focus:border-indigo-500">
            <option value="Reunión"> Reunión</option>
            <option value="Pago"> Pago</option>
            <option value="Cobro">Cobro</option>
            <option value="Evento"> Evento</option>
            <option value="Recordatorio"> Recordatorio</option>
          </select>
      </div>

      <div class="md:col-span-1">
          <input id="inpMonto" type="number" placeholder="Monto ($0 si no aplica)" step="0.01"
            class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-3 text-white focus:outline-none focus:border-indigo-500" />
      </div>

      <div class="md:col-span-2">
          <input id="inpEmail" type="email" placeholder=" Email para recordatorio (Opcional)"
            class="w-full bg-slate-900 border border-indigo-500/30 rounded px-3 py-3 text-white focus:outline-none focus:border-indigo-500" />
      </div>

      <button id="btnGuardar" type="submit"
        class="bg-indigo-600 hover:bg-indigo-700 transition rounded px-4 py-3 font-semibold md:col-span-4 text-white shadow-lg shadow-indigo-500/20 mt-2">
        Agendar en Calendario
      </button>

    </form>
  </section>

  <section class="glass rounded-xl p-8">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-semibold text-indigo-300">Vista mensual</h3>
        <div class="flex gap-3 text-xs flex-wrap">
            <span class="flex items-center text-gray-400"><span class="w-2 h-2 bg-indigo-500 rounded-full mr-1"></span> Reunión/Evento</span>
            <span class="flex items-center text-gray-400"><span class="w-2 h-2 bg-red-500 rounded-full mr-1"></span> Pago Pendiente</span>
            <span class="flex items-center text-gray-400"><span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span> Completado</span>
        </div>
    </div>

    <div class="grid grid-cols-7 gap-3 text-center text-sm mb-2">
      <div class="text-slate-500 font-bold">Lun</div>
      <div class="text-slate-500 font-bold">Mar</div>
      <div class="text-slate-500 font-bold">Mié</div>
      <div class="text-slate-500 font-bold">Jue</div>
      <div class="text-slate-500 font-bold">Vie</div>
      <div class="text-slate-500 font-bold">Sáb</div>
      <div class="text-slate-500 font-bold text-red-400">Dom</div>
    </div>

    <div id="calendar-grid" class="grid grid-cols-7 gap-3 text-sm">
        <p class="col-span-7 text-center py-10 text-gray-500">Cargando tu agenda...</p>
    </div>
  </section>

  <section class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-5xl">

    <a href="obligaciones.html" class="glass rounded-xl p-6 hover-card block hover:bg-slate-800/50 transition">
      <h4 class="font-semibold text-lg mb-2 text-indigo-400">
        Ver lista detallada
      </h4>
      <p class="text-slate-300 text-sm">
        Gestiona el estado (pagado/pendiente) de tus compromisos.
      </p>
      <p class="mt-4 text-white text-sm font-semibold">
        Ir a obligaciones →
      </p>
    </a>

    <a href="flujo-caja.html" class="glass rounded-xl p-6 hover-card block hover:bg-slate-800/50 transition">
      <h4 class="font-semibold text-lg mb-2 text-indigo-400">
        Impacto en el flujo de caja
      </h4>
      <p class="text-slate-300 text-sm">
        Visualiza cómo los vencimientos afectan tu liquidez.
      </p>
      <p class="mt-4 text-white text-sm font-semibold">
        Ver flujo →
      </p>
    </a>

  </section>

  <section class="text-center text-slate-400 text-sm pt-6 pb-10">
    Anticiparse es una ventaja competitiva.
  </section>

</main>

<script>
// Notificaciones
function pymaxNotify({ title = "Pymax", message = "", type = "info" }) {
  const container = document.getElementById("pymax-toast-container");
  const colors = {
    info: "from-blue-500/20 to-indigo-500/20 border-blue-400/30",
    success: "from-emerald-500/20 to-green-500/20 border-emerald-400/30",
    error: "from-red-500/20 to-pink-500/20 border-red-400/30"
  };
  const toast = document.createElement("div");
  toast.className = `relative overflow-hidden backdrop-blur-xl bg-gradient-to-r ${colors[type]} border text-white px-5 py-4 rounded-xl shadow-xl max-w-sm mb-3 transition-all transform duration-500`;
  toast.innerHTML = `<div class="font-semibold text-sm mb-1">${title}</div><div class="text-sm text-gray-200">${message}</div>`;
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add("opacity-0", "translate-x-5");
    setTimeout(() => toast.remove(), 400);
  }, 4000);
}

// Lógica Calendario
document.addEventListener("DOMContentLoaded", async () => {
    if (typeof pymaxGetUser === 'undefined') return;
    const user = await pymaxGetUser();
    if (!user) { window.location.href = "../index.html"; return; }

    const fechaActual = new Date();
    document.getElementById("inpFecha").valueAsDate = fechaActual;
    if(user.email) document.getElementById("inpEmail").value = user.email;

    // Título Mes
    const nombreMes = fechaActual.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
    document.getElementById("mes-actual-titulo").innerText = nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1);

    await cargarCalendario(user.id, fechaActual);

    // GUARDAR
    document.getElementById("formCalendario").addEventListener("submit", async (e) => {
        e.preventDefault();
        const btn = document.getElementById("btnGuardar");

        const titulo = document.getElementById("inpDesc").value.trim();
        const categoria = document.getElementById("inpTipoSelect").value;
        const montoVal = document.getElementById("inpMonto").value;
        const monto = montoVal ? parseFloat(montoVal) : 0;
        const fecha = document.getElementById("inpFecha").value;
        const email = document.getElementById("inpEmail").value.trim();

        const descripcionFinal = `${categoria}: ${titulo}`;

        if(!titulo || !fecha) return;

        btn.disabled = true; btn.innerText = "Agendando...";

        const { error } = await window.supabase
            .from('obligaciones')
            .insert([{
                user_id: user.id,
                tipo: descripcionFinal,
                monto: monto,
                fecha_pago: fecha,
                estado: 'pendiente',
                email_contacto: email || null
            }]);

        btn.disabled = false; btn.innerText = "Agendar en Calendario";

        if(error) {
            pymaxNotify({ title: "Error", message: "No se pudo guardar.", type: "error" });
        } else {
            pymaxNotify({ title: "Agendado", message: "Actividad guardada.", type: "success" });
            document.getElementById("inpDesc").value = "";
            document.getElementById("inpMonto").value = "";
            await cargarCalendario(user.id, fechaActual);
        }
    });
});

async function cargarCalendario(userId, fechaRef) {
    const grid = document.getElementById("calendar-grid");
    grid.innerHTML = ""; 

    const mes = fechaRef.getMonth();
    const anio = fechaRef.getFullYear();
    
    // Obtener datos
    const { data: obligaciones } = await window.supabase
        .from('obligaciones')
        .select('*')
        .eq('user_id', userId);

    actualizarEstadisticas(obligaciones, mes, anio);

    // DIBUJAR CALENDARIO
    const primerDiaSemana = new Date(anio, mes, 1).getDay(); 
    let huecos = primerDiaSemana === 0 ? 6 : primerDiaSemana - 1;
    const diasEnMes = new Date(anio, mes + 1, 0).getDate();

    // Huecos vacíos
    for(let i=0; i<huecos; i++) {
        const div = document.createElement("div");
        div.className = "rounded-lg bg-slate-900/20 border border-transparent";
        grid.appendChild(div);
    }

    const hoyStr = new Date().toISOString().split('T')[0];

    for(let dia=1; dia<=diasEnMes; dia++) {
        const diaStr = String(dia).padStart(2, '0');
        const mesStr = String(mes + 1).padStart(2, '0');
        const fechaCelda = `${anio}-${mesStr}-${diaStr}`;

        const div = document.createElement("div");
        let clases = "day glass rounded-lg p-2 text-slate-300 border border-slate-700/50 relative overflow-hidden";
        
        if (fechaCelda === hoyStr) clases += " ring-2 ring-indigo-500 bg-indigo-500/10";
        div.className = clases;
        
        div.innerHTML = `<span class="font-bold text-xs mb-1 block text-slate-500">${dia}</span>`;

        if(obligaciones) {
            const eventosDia = obligaciones.filter(o => o.fecha_pago === fechaCelda);
            
            eventosDia.forEach(ev => {
                let color = "bg-indigo-500"; // Color por defecto (Reuniones)
                
                // Si es dinero (>0) y pendiente -> Rojo. Si pagado -> Verde.
                if (ev.monto > 0) {
                    color = ev.estado === 'pendiente' ? 'bg-red-500' : 'bg-green-500';
                }

                // Etiqueta visual
                const etiqueta = document.createElement("div");
                etiqueta.className = `text-[10px] w-full rounded px-1.5 py-0.5 mb-1 truncate text-white ${color} bg-opacity-80 shadow-sm cursor-help`;
                etiqueta.title = `${ev.tipo} ($${ev.monto})`;
                etiqueta.innerText = ev.tipo;
                
                div.appendChild(etiqueta);
            });
        }
        grid.appendChild(div);
    }
}

function actualizarEstadisticas(obligaciones, mes, anio) {
    if(!obligaciones) return;
    const hoyStr = new Date().toISOString().split('T')[0];
    let totalMes = 0, vencidos = 0;
    let proximoFecha = null, proximoTexto = "—";

    obligaciones.forEach(o => {
        const f = new Date(o.fecha_pago + "T00:00:00");
        if(f.getMonth() === mes && f.getFullYear() === anio) totalMes++;
        
        if (o.estado === 'pendiente' && o.fecha_pago < hoyStr) vencidos++;
        
        if (o.estado === 'pendiente' && o.fecha_pago >= hoyStr) {
            if (!proximoFecha || o.fecha_pago < proximoFecha) {
                proximoFecha = o.fecha_pago;
                proximoTexto = `${o.fecha_pago.split('-')[2]}/${o.fecha_pago.split('-')[1]} - ${o.tipo}`;
            }
        }
    });

    document.getElementById("val-total-mes").innerText = totalMes;
    document.getElementById("val-vencidos").innerText = vencidos;
    document.getElementById("val-proximo").innerText = proximoTexto;
    
    const divVenc = document.getElementById("val-vencidos");
    if(vencidos > 0) divVenc.className = "text-3xl font-bold text-red-500 mt-2 animate-pulse";
    else divVenc.className = "text-3xl font-bold text-red-400 mt-2";
}
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Busca TODOS los enlaces (<a>) de tu código original
    document.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', function(e) {
            let url = this.getAttribute('href');
            
            // Solo actuamos si el enlace apunta a un archivo .html
            if (url && url.includes('.html')) {
                e.preventDefault(); // Detiene el error 404
                
                // 1. Quita la extensión .html automáticamente
                let nuevaRuta = url.replace('.html', '');

                // 2. DICCIONARIO DE CORRECCIONES (Para los botones "Volver")
                // Aquí le enseñamos a ir a las rutas principales correctas
                if (url.includes('panel-mover.html')) nuevaRuta = "/empresa/mover";
                if (url.includes('index-empresa.html')) nuevaRuta = "/empresa";
                if (url.includes('index.html')) nuevaRuta = "/";

                // 3. Te envía a la ruta limpia de Python
                window.location.href = nuevaRuta;
            }
        });
    });
});
</script>
</body> 
</html>