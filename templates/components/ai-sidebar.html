<!-- SIDEBAR DE IA - Análisis Contextual -->
<div id="aiSidebar" class="fixed top-20 right-0 w-96 h-[calc(100vh-5rem)] bg-slate-900/95 backdrop-blur-xl border-l border-white/10 shadow-2xl transform translate-x-full transition-transform duration-300 z-40 flex flex-col">
    <!-- Header -->
    <div class="p-6 border-b border-white/10">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-violet-600 to-blue-600 flex items-center justify-center animate-pulse">
                    <i class="ph-bold ph-brain text-white text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-white">Pymax AI</h3>
                    <p class="text-xs text-slate-400">Tu copiloto financiero</p>
                </div>
            </div>
            <button onclick="toggleAISidebar()" class="text-slate-400 hover:text-white">
                <i class="ph-bold ph-x text-xl"></i>
            </button>
        </div>
        
        <!-- Status -->
        <div class="flex items-center gap-2 text-xs">
            <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></div>
            <span class="text-slate-400">Analizando en tiempo real</span>
        </div>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto p-6 space-y-4" id="aiInsightsContainer">
        <!-- Los insights se generan dinámicamente -->
        <div class="text-center text-slate-500 py-8">
            <i class="ph-duotone ph-chart-line-up text-4xl mb-2"></i>
            <p class="text-sm">Analizando datos...</p>
        </div>
    </div>

    <!-- Actions -->
    <div class="p-6 border-t border-white/10 space-y-3">
        <button onclick="generateFullReport()" class="w-full px-4 py-3 rounded-lg bg-gradient-to-r from-violet-600 to-blue-600 text-white font-medium hover:shadow-lg hover:shadow-violet-500/50 transition flex items-center justify-center gap-2">
            <i class="ph-bold ph-file-text"></i>
            <span>Generar Reporte</span>
        </button>
        <button onclick="openAIChat()" disabled class="w-full px-4 py-3 rounded-lg border border-violet-500/30 text-violet-400/50 font-medium flex items-center justify-center gap-2 cursor-not-allowed">
            <i class="ph-bold ph-chat-dots"></i>
            <span>Chat con IA</span>
            <span class="ml-auto text-xs bg-violet-500/20 px-2 py-0.5 rounded">Premium</span>
        </button>
    </div>
</div>

<!-- Toggle Button (cuando está cerrado) -->
<button id="aiToggleBtn" onclick="toggleAISidebar()" class="fixed top-24 right-4 w-12 h-12 bg-gradient-to-r from-violet-600 to-blue-600 rounded-full shadow-lg hover:shadow-violet-500/50 transition-all duration-300 flex items-center justify-center z-30 hover:scale-110">
    <i class="ph-bold ph-brain text-white text-xl animate-pulse"></i>
</button>

<style>
#aiSidebar.open {
    transform: translateX(0);
}

#aiToggleBtn.hidden {
    opacity: 0;
    pointer-events: none;
}

.insight-card {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.8) 0%, rgba(15, 23, 42, 0.4) 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 16px;
    transition: all 0.3s ease;
}

.insight-card:hover {
    border-color: rgba(124, 58, 237, 0.5);
    transform: translateY(-2px);
}

.insight-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-center;
    font-size: 20px;
}

.insight-success { background: rgba(52, 211, 153, 0.1); color: #34d399; }
.insight-warning { background: rgba(251, 191, 36, 0.1); color: #fbbf24; }
.insight-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
.insight-info { background: rgba(96, 165, 250, 0.1); color: #60a5fa; }
</style>

<script>
let aiSidebarOpen = false;

function toggleAISidebar() {
    const sidebar = document.getElementById('aiSidebar');
    const toggleBtn = document.getElementById('aiToggleBtn');
    
    aiSidebarOpen = !aiSidebarOpen;
    
    if (aiSidebarOpen) {
        sidebar.classList.add('open');
        toggleBtn.classList.add('hidden');
        generateAIInsights();
    } else {
        sidebar.classList.remove('open');
        toggleBtn.classList.remove('hidden');
    }
}

async function generateAIInsights() {
    const container = document.getElementById('aiInsightsContainer');
    container.innerHTML = '<div class="text-center text-slate-500 py-4"><div class="animate-spin w-8 h-8 border-2 border-violet-500 border-t-transparent rounded-full mx-auto mb-2"></div><p class="text-sm">Analizando...</p></div>';
    
    // Simular delay de análisis
    await new Promise(resolve => setTimeout(resolve, 800));
    
    const insights = [];
    
    // Si hay Data Manager, usar datos reales
    if (window.pymaxData && window.pymaxData.cache) {
        const cache = window.pymaxData.cache;
        const stats = window.pymaxData.getFinancialStats ? window.pymaxData.getFinancialStats('month') : null;
        
        if (stats) {
            // Insight 1: Salud financiera
            if (stats.balance > 0) {
                insights.push({
                    type: 'success',
                    icon: 'ph-check-circle',
                    title: 'Salud Financiera Positiva',
                    description: `Tu balance es $${stats.balance.toLocaleString()}. Margen del ${stats.margin}%.`,
                    action: 'Ver detalles',
                    actionFn: 'goToFlujoCaja()'
                });
            } else {
                insights.push({
                    type: 'danger',
                    icon: 'ph-warning',
                    title: 'Alerta: Balance Negativo',
                    description: `Déficit de $${Math.abs(stats.balance).toLocaleString()}. Revisa tus gastos.`,
                    action: 'Analizar gastos',
                    actionFn: 'goToTransacciones()'
                });
            }
            
            // Insight 2: Tendencia
            if (stats.income > stats.expenses) {
                const surplus = stats.income - stats.expenses;
                insights.push({
                    type: 'success',
                    icon: 'ph-trend-up',
                    title: 'Superávit del Mes',
                    description: `Ganaste $${surplus.toLocaleString()} más de lo que gastaste.`,
                    action: null
                });
            }
            
            // Insight 3: Recomendación de ahorro
            if (stats.margin < 20 && stats.margin > 0) {
                const potentialSavings = stats.expenses * 0.1;
                insights.push({
                    type: 'warning',
                    icon: 'ph-piggy-bank',
                    title: 'Oportunidad de Ahorro',
                    description: `Reducir gastos en 10% liberaría $${potentialSavings.toLocaleString()}.`,
                    action: 'Ver gastos',
                    actionFn: 'goToTransacciones()'
                });
            }
            
            // Insight 4: Meta progress
            const goals = cache.goals || {};
            const activeGoals = Object.values(goals).filter(Boolean);
            if (activeGoals.length > 0) {
                insights.push({
                    type: 'info',
                    icon: 'ph-target',
                    title: `${activeGoals.length} Meta${activeGoals.length > 1 ? 's' : ''} Activa${activeGoals.length > 1 ? 's' : ''}`,
                    description: 'Tus metas se actualizan automáticamente con cada transacción.',
                    action: 'Ver metas',
                    actionFn: 'goToMetas()'
                });
            }
            
            // Insight 5: Transacciones recientes
            if (stats.operations > 0) {
                insights.push({
                    type: 'info',
                    icon: 'ph-activity',
                    title: 'Actividad Reciente',
                    description: `${stats.operations} transacciones este mes. ${stats.incomeCount} ingresos, ${stats.expensesCount} gastos.`,
                    action: null
                });
            }
            
            // Insight 6: Inventario bajo
            const lowStock = (cache.inventory || []).filter(item => {
                const qty = parseInt(item.quantity) || 0;
                const min = parseInt(item.min_stock) || 0;
                return qty <= min && qty > 0;
            });
            
            if (lowStock.length > 0) {
                insights.push({
                    type: 'warning',
                    icon: 'ph-warning-circle',
                    title: 'Stock Bajo',
                    description: `${lowStock.length} producto${lowStock.length > 1 ? 's' : ''} con stock bajo o agotándose.`,
                    action: 'Ver inventario',
                    actionFn: 'goToInventario()'
                });
            }
            
            // Insight 7: Obligaciones próximas
            const upcomingObligations = (cache.obligations || []).filter(obl => {
                if (obl.status === 'pagado') return false;
                const dueDate = new Date(obl.due_date);
                const now = new Date();
                const daysUntil = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));
                return daysUntil <= 7 && daysUntil >= 0;
            });
            
            if (upcomingObligations.length > 0) {
                const total = upcomingObligations.reduce((sum, o) => sum + parseFloat(o.amount || 0), 0);
                insights.push({
                    type: 'warning',
                    icon: 'ph-calendar-x',
                    title: 'Pagos Próximos',
                    description: `${upcomingObligations.length} obligación${upcomingObligations.length > 1 ? 'es' : ''} vencen esta semana. Total: $${total.toLocaleString()}.`,
                    action: 'Ver obligaciones',
                    actionFn: 'goToObligaciones()'
                });
            }
        }
    }
    
    // Si no hay insights, mostrar tips generales
    if (insights.length === 0) {
        insights.push(
            {
                type: 'info',
                icon: 'ph-lightbulb',
                title: 'Empieza a Registrar',
                description: 'Registra tus primeras transacciones para ver análisis personalizados.',
                action: 'Registrar ahora',
                actionFn: 'openQuickAdd()'
            },
            {
                type: 'info',
                icon: 'ph-chart-line',
                title: 'Conecta Todo',
                description: 'Vincula CRM, operaciones e inventario para análisis completo.',
                action: null
            }
        );
    }
    
    // Renderizar insights
    container.innerHTML = insights.map(insight => `
        <div class="insight-card">
            <div class="flex gap-3">
                <div class="insight-icon insight-${insight.type}">
                    <i class="ph-bold ${insight.icon}"></i>
                </div>
                <div class="flex-1">
                    <h4 class="text-sm font-bold text-white mb-1">${insight.title}</h4>
                    <p class="text-xs text-slate-400 leading-relaxed">${insight.description}</p>
                    ${insight.action ? `
                        <button onclick="${insight.actionFn}" class="mt-2 text-xs text-violet-400 hover:text-violet-300 font-medium">
                            ${insight.action} →
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');
}

// Navigation helpers
function goToFlujoCaja() {
    window.location.href = '/empresa/mover/flujo';
}

function goToTransacciones() {
    window.location.href = '/empresa/mover/ventas-gastos';
}

function goToMetas() {
    window.location.href = '/empresa/mover/metas';
}

function goToInventario() {
    window.location.href = '/empresa/mover/inventario';
}

function goToObligaciones() {
    window.location.href = '/empresa/mover/obligaciones';
}

function generateFullReport() {
    alert('Generando reporte completo... (Feature próximamente)');
}

function openAIChat() {
    alert('Chat con IA disponible en plan Premium');
}

// Auto-refresh insights cada 30 segundos
setInterval(() => {
    if (aiSidebarOpen) {
        generateAIInsights();
    }
}, 30000);
</script>
