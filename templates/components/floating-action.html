<!-- BOT√ìN FLOTANTE UNIVERSAL - Quick Add -->
<div id="floating-action-btn" class="fixed bottom-8 right-8 z-50 group">
    <button onclick="openQuickAdd()" class="w-16 h-16 bg-gradient-to-r from-violet-600 to-blue-600 rounded-full shadow-2xl hover:shadow-violet-500/50 transition-all duration-300 flex items-center justify-center hover:scale-110 group-hover:rotate-90">
        <i class="ph-bold ph-plus text-white text-2xl"></i>
    </button>
    <div class="absolute bottom-20 right-0 bg-slate-900/95 backdrop-blur-sm rounded-lg shadow-xl border border-white/10 p-2 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
        <p class="text-xs text-slate-300 whitespace-nowrap px-2">Quick Add</p>
    </div>
</div>

<!-- MODAL QUICK ADD -->
<div id="quickAddModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden items-center justify-center">
    <div class="bg-slate-900 rounded-2xl border border-white/10 w-full max-w-2xl mx-4 shadow-2xl transform transition-all">
        <!-- Header -->
        <div class="p-6 border-b border-white/10">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-violet-600 to-blue-600 flex items-center justify-center">
                        <i class="ph-bold ph-lightning text-white text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-white">Registro R√°pido</h3>
                        <p class="text-xs text-slate-400">A√±ade ingresos o gastos en segundos</p>
                    </div>
                </div>
                <button onclick="closeQuickAdd()" class="text-slate-400 hover:text-white">
                    <i class="ph-bold ph-x text-2xl"></i>
                </button>
            </div>
        </div>

        <!-- Body -->
        <div class="p-6 space-y-6">
            <!-- Quick Input (Chat Style) -->
            <div>
                <label class="text-sm text-slate-400 mb-2 block">üí¨ Escribe r√°pido</label>
                <input 
                    type="text" 
                    id="quickInput" 
                    placeholder='Ej: "Venta 150000 cliente ABC" o "Gasto 25000 almuerzo"'
                    class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20 outline-none"
                    onkeypress="if(event.key==='Enter') parseQuickInput()"
                />
                <p class="text-xs text-slate-500 mt-1">Escribe el tipo (ingreso/gasto), monto y descripci√≥n</p>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex-1 border-t border-slate-700"></div>
                <span class="text-xs text-slate-500">o usa el formulario</span>
                <div class="flex-1 border-t border-slate-700"></div>
            </div>

            <!-- Form -->
            <div class="grid grid-cols-2 gap-4">
                <!-- Tipo -->
                <div class="col-span-2">
                    <label class="text-sm text-slate-400 mb-2 block">Tipo</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setTransactionType('ingreso')" id="btnIngreso" class="px-4 py-3 rounded-lg border border-emerald-500 bg-emerald-500/10 text-emerald-400 font-medium hover:bg-emerald-500/20 transition">
                            <i class="ph-bold ph-arrow-up-right mr-2"></i>Ingreso
                        </button>
                        <button onclick="setTransactionType('egreso')" id="btnEgreso" class="px-4 py-3 rounded-lg border border-slate-700 text-slate-400 font-medium hover:border-rose-500 hover:bg-rose-500/10 hover:text-rose-400 transition">
                            <i class="ph-bold ph-arrow-down-left mr-2"></i>Gasto
                        </button>
                    </div>
                </div>

                <!-- Monto -->
                <div>
                    <label class="text-sm text-slate-400 mb-2 block">Monto</label>
                    <input type="number" id="quickMonto" placeholder="0" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:border-violet-500 outline-none" />
                </div>

                <!-- Categor√≠a -->
                <div>
                    <label class="text-sm text-slate-400 mb-2 block">Categor√≠a</label>
                    <select id="quickCategoria" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-violet-500 outline-none">
                        <option value="">Seleccionar...</option>
                        <!-- Se llena din√°micamente -->
                    </select>
                </div>

                <!-- Concepto -->
                <div class="col-span-2">
                    <label class="text-sm text-slate-400 mb-2 block">Concepto</label>
                    <input type="text" id="quickConcepto" placeholder="Descripci√≥n breve" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-500 focus:border-violet-500 outline-none" />
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-6 border-t border-white/10 flex justify-end gap-3">
            <button onclick="closeQuickAdd()" class="px-6 py-2.5 rounded-lg bg-slate-800 text-slate-300 hover:bg-slate-700 transition">
                Cancelar
            </button>
            <button onclick="saveQuickTransaction()" class="px-6 py-2.5 rounded-lg bg-gradient-to-r from-violet-600 to-blue-600 text-white font-medium hover:shadow-lg hover:shadow-violet-500/50 transition">
                <i class="ph-bold ph-check mr-2"></i>Guardar
            </button>
        </div>
    </div>
</div>

<script>
let currentType = 'ingreso';

// Categor√≠as por tipo
const CATEGORIES = {
    ingreso: ['Ventas', 'Servicios', 'Consultor√≠a', 'Suscripci√≥n', 'Inversi√≥n', 'Pr√©stamo', 'Otros Ingresos'],
    egreso: ['Arriendo', 'Servicios', 'Sueldos', 'Marketing', 'Software', 'Oficina', 'Seguros', 'Impuestos', 'Transporte', 'Mantenimiento', 'Otros Gastos']
};

function openQuickAdd() {
    document.getElementById('quickAddModal').classList.remove('hidden');
    document.getElementById('quickAddModal').classList.add('flex');
    document.getElementById('quickInput').focus();
    updateCategories();
}

function closeQuickAdd() {
    document.getElementById('quickAddModal').classList.add('hidden');
    document.getElementById('quickAddModal').classList.remove('flex');
    clearQuickForm();
}

function setTransactionType(type) {
    currentType = type;
    const btnIngreso = document.getElementById('btnIngreso');
    const btnEgreso = document.getElementById('btnEgreso');
    
    if (type === 'ingreso') {
        btnIngreso.className = 'px-4 py-3 rounded-lg border border-emerald-500 bg-emerald-500/10 text-emerald-400 font-medium';
        btnEgreso.className = 'px-4 py-3 rounded-lg border border-slate-700 text-slate-400 font-medium hover:border-rose-500 hover:bg-rose-500/10 hover:text-rose-400 transition';
    } else {
        btnEgreso.className = 'px-4 py-3 rounded-lg border border-rose-500 bg-rose-500/10 text-rose-400 font-medium';
        btnIngreso.className = 'px-4 py-3 rounded-lg border border-slate-700 text-slate-400 font-medium hover:border-emerald-500 hover:bg-emerald-500/10 hover:text-emerald-400 transition';
    }
    
    updateCategories();
}

function updateCategories() {
    const select = document.getElementById('quickCategoria');
    select.innerHTML = '<option value="">Seleccionar...</option>';
    CATEGORIES[currentType].forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        select.appendChild(option);
    });
}

function parseQuickInput() {
    const input = document.getElementById('quickInput').value.trim().toLowerCase();
    if (!input) return;
    
    // Detectar tipo
    if (input.includes('ingreso') || input.includes('venta') || input.includes('cobro')) {
        setTransactionType('ingreso');
    } else if (input.includes('gasto') || input.includes('pago') || input.includes('compra')) {
        setTransactionType('egreso');
    }
    
    // Extraer monto (busca n√∫meros)
    const montoMatch = input.match(/\d+/);
    if (montoMatch) {
        document.getElementById('quickMonto').value = montoMatch[0];
    }
    
    // Concepto (resto del texto sin n√∫meros ni palabras clave)
    let concepto = input
        .replace(/ingreso|venta|cobro|gasto|pago|compra/g, '')
        .replace(/\d+/g, '')
        .trim();
    document.getElementById('quickConcepto').value = concepto;
    
    // Auto-categorizar
    suggestCategory(concepto);
    
    // Focus en guardar
    document.querySelector('[onclick="saveQuickTransaction()"]').focus();
}

function suggestCategory(text) {
    const keywords = {
        'Arriendo': ['arriendo', 'alquiler', 'renta'],
        'Servicios': ['luz', 'agua', 'gas', 'internet', 'electricidad'],
        'Sueldos': ['sueldo', 'salario', 'n√≥mina', 'planilla'],
        'Marketing': ['publicidad', 'marketing', 'ads', 'facebook', 'google'],
        'Software': ['software', 'licencia', 'saas', 'suscripci√≥n'],
        'Transporte': ['combustible', 'bencina', 'uber', 'taxi', 'transporte'],
        'Ventas': ['venta', 'cliente', 'factura'],
        'Servicios': ['servicio', 'consultor√≠a', 'asesor√≠a']
    };
    
    const lowerText = text.toLowerCase();
    for (const [category, words] of Object.entries(keywords)) {
        if (words.some(word => lowerText.includes(word))) {
            if (CATEGORIES[currentType].includes(category)) {
                document.getElementById('quickCategoria').value = category;
                break;
            }
        }
    }
}

async function saveQuickTransaction() {
    const monto = parseFloat(document.getElementById('quickMonto').value);
    const categoria = document.getElementById('quickCategoria').value;
    const concepto = document.getElementById('quickConcepto').value;
    
    if (!monto || !concepto) {
        alert('Por favor completa al menos el monto y concepto');
        return;
    }
    
    // Guardar usando Data Manager (si est√° disponible)
    if (window.pymaxData) {
        try {
            await pymaxData.addOperation({
                type: currentType,
                amount: monto,
                concept: concepto,
                category: categoria || 'Sin categor√≠a'
            });
            
            closeQuickAdd();
            
            // Feedback visual
            showToast('‚úì Transacci√≥n registrada', 'success');
        } catch (error) {
            console.error('Error guardando:', error);
            showToast('Error al guardar', 'error');
        }
    } else {
        alert('Sistema de datos no disponible. Refresca la p√°gina.');
    }
}

function clearQuickForm() {
    document.getElementById('quickInput').value = '';
    document.getElementById('quickMonto').value = '';
    document.getElementById('quickConcepto').value = '';
    document.getElementById('quickCategoria').value = '';
    setTransactionType('ingreso');
}

function showToast(message, type = 'info') {
    // Simple toast (puedes mejorar con SweetAlert o similar)
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white font-medium shadow-lg z-[200] ${
        type === 'success' ? 'bg-emerald-600' : 'bg-rose-600'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Shortcut: Ctrl/Cmd + K para abrir quick add
document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openQuickAdd();
    }
    // ESC para cerrar
    if (e.key === 'Escape') {
        closeQuickAdd();
    }
});
</script>
